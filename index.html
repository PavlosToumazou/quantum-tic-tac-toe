// 2. Επαναληπτική Διαδοχική Κατάρρευση (Deterministic Propagation)
let collapseOccurred = true;

while (collapseOccurred) {
    collapseOccurred = false;

    // --- ΠΕΡΑΣΜΑ 1: Όλα τα οριστικά κελιά επηρεάζουν τα γειτονικά ---
    for (let i = 0; i < 9; i++) {
        if (boardState[i].definite !== null) {
            // ΚΑΝΟΝΑΣ 1: Ένα κελί i είναι οριστικό.
            for (const move of superpositionMoves) {
                if (move.cells.includes(i)) {
                    const otherCell = move.cells.find(c => c !== i);

                    const beforeLen = boardState[otherCell].superposition.length;
                    boardState[otherCell].superposition =
                        boardState[otherCell].superposition.filter(id => id !== move.id);

                    if (boardState[otherCell].superposition.length !== beforeLen) {
                        collapseOccurred = true; // κάτι άλλαξε, ίσως δημιουργηθεί νέο οριστικό κελί
                    }
                }
            }
        }
    }

    // --- ΠΕΡΑΣΜΑ 2: Όσα κελιά έχουν πια 1 πιθανή κίνηση γίνονται οριστικά ---
    for (let i = 0; i < 9; i++) {
        if (boardState[i].definite === null &&
            boardState[i].superposition.length === 1) {

            const winningMoveId = boardState[i].superposition[0];
            const winningMove = superpositionMoves.find(m => m.id === winningMoveId);

            if (winningMove) {
                boardState[i].definite = winningMove.player;
                boardState[i].superposition = [];
                collapseOccurred = true; // νέο οριστικό κελί → ξανατρέχει ο βρόχος
            }
        }
    }
}
